<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cookie Challenge</title>
    <style>
        html, body { margin:0; height:100%; background:#111; color:#fff; font-family:sans-serif; overflow:hidden; }
        #outer { display:flex; flex-direction:column; height:100%; }
        #ui { font-size:20px; text-align:center; margin:6px 0; }
        #canvasWrap { flex:1; display:flex; justify-content:center; align-items:center; }
        #gameCanvas { background:#000; border:4px solid #fff; touch-action:none; max-width:98vw; max-height:65vh; cursor: pointer; }
        .overlay { position: fixed; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; z-index: 20; }
        #titleScreen { background: #000 url('title.png') center/contain no-repeat; }
        #titleContent { position:relative; z-index:1; background: rgba(0,0,0,0.3); padding: 2rem; border-radius: 15px; }
        #titleContent h1 { font-size:9vw; margin:0 0 15px; text-shadow:0 0 15px #000; }
        #titleContent button { padding:12px 28px; font-size:5.5vw; font-weight: bold; border: 2px solid #fff; border-radius:10px; background:#ff8c00; color:#fff; cursor: pointer; }
        #levelMessage { background: rgba(0,0,0,0.85); color: #fff; display: none; padding: 20px; }
        #levelMessage h2 { font-size: 6vw; color: #ff8c00; }
        #muteBtn { position:fixed; top:10px; right:10px; z-index:10; font-size:18px; padding:6px 10px; border:none; border-radius:4px; background:#d69c4e; color:#111; cursor: pointer; }
        #controls { position:fixed; bottom:12px; left:50%; transform:translateX(-50%); z-index:9; width:210px; height:170px; }
        .btn { position:absolute; width:68px; height:68px; border-radius:50%; background:rgba(255,255,255,.25); border:2px solid #fff; display:flex; justify-content:center; align-items:center; user-select:none; }
        .btn:active { background:#fff; color:#000; }
        #up { top:0; left:71px; } #down { bottom:0; left:71px; } #left { left:0; top:50%; transform:translateY(-50%); } #right { right:0; top:50%; transform:translateY(-50%); }
        .btn span { font-size:30px; pointer-events:none; }
        @media(pointer:fine) { #controls { display:none; } }
        #loading { position:fixed; inset:0; background:#000; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:50; }
        #loading h2 { color:#ff8c00; font-size:5vw; }
    </style>
</head>
<body>
    <div id="loading"><h2>Loading Game Assets...</h2><p>Please wait</p></div>
    <div id="outer">
        <p id="ui" style="display:none">Score: 0</p>
        <div id="canvasWrap"><canvas id="gameCanvas"></canvas></div>
    </div>
    <div id="titleScreen" class="overlay">
        <div id="titleContent">
            <h1>Cookie Challenge</h1>
            <button id="startBtn">Start Game</button>
        </div>
    </div>
    <div id="levelMessage" class="overlay">
        <h2>Blaster Unlocked!</h2>
        <p>Grab the lightning bolt to auto-shoot enemies!</p>
        <p class="hint">(Click or press any key to continue)</p>
    </div>
    <div id="controls">
        <div id="up" class="btn"><span>â–²</span></div>
        <div id="down" class="btn"><span>â–¼</span></div>
        <div id="left" class="btn"><span>â—€</span></div>
        <div id="right" class="btn"><span>â–¶</span></div>
    </div>
    <button id="muteBtn">ðŸ”Š</button>
    <audio id="bgm"></audio>
    <audio id="starMusic"></audio>

<script>
const PS=3, PS_BOOST=6, BASE_MS=1.8, BASE_CR=15, BASE_MR=20, BIG_MONSTER_R=28, PR=20;
const BOOST_R=20, PLAYER_BULLET_R=8, MONSTER_BULLET_R=8, STAR_TIME=5000, BLASTER_TIME=5000;
const MONSTER_SHOOT_LEVEL=4, MONSTER_SPAWN_BUFFER=150, MON_SHOOT_COOLDOWN=6000, AUTO_FIRE_RATE=200, POWERUP_LIFETIME=10000;

const ASSETS={
    player:'assets/sprites/extracted_kenney_space-shooter/PNG/playerShip1_blue.png',
    enemies:[
        'assets/sprites/extracted_kenney_space-shooter/PNG/Enemies/enemyBlack1.png','assets/sprites/extracted_kenney_space-shooter/PNG/Enemies/enemyBlack2.png','assets/sprites/extracted_kenney_space-shooter/PNG/Enemies/enemyBlack3.png','assets/sprites/extracted_kenney_space-shooter/PNG/Enemies/enemyBlack4.png','assets/sprites/extracted_kenney_space-shooter/PNG/Enemies/enemyBlack5.png',
        'assets/sprites/extracted_kenney_space-shooter/PNG/Enemies/enemyBlue1.png','assets/sprites/extracted_kenney_space-shooter/PNG/Enemies/enemyBlue2.png','assets/sprites/extracted_kenney_space-shooter/PNG/Enemies/enemyBlue3.png','assets/sprites/extracted_kenney_space-shooter/PNG/Enemies/enemyBlue4.png','assets/sprites/extracted_kenney_space-shooter/PNG/Enemies/enemyBlue5.png',
        'assets/sprites/extracted_kenney_space-shooter/PNG/Enemies/enemyGreen1.png','assets/sprites/extracted_kenney_space-shooter/PNG/Enemies/enemyGreen2.png','assets/sprites/extracted_kenney_space-shooter/PNG/Enemies/enemyGreen3.png','assets/sprites/extracted_kenney_space-shooter/PNG/Enemies/enemyGreen4.png','assets/sprites/extracted_kenney_space-shooter/PNG/Enemies/enemyGreen5.png',
        'assets/sprites/extracted_kenney_space-shooter/PNG/Enemies/enemyRed1.png','assets/sprites/extracted_kenney_space-shooter/PNG/Enemies/enemyRed2.png','assets/sprites/extracted_kenney_space-shooter/PNG/Enemies/enemyRed3.png','assets/sprites/extracted_kenney_space-shooter/PNG/Enemies/enemyRed4.png','assets/sprites/extracted_kenney_space-shooter/PNG/Enemies/enemyRed5.png'
    ],
    cookies:['apple','avocado','banana','beer','boiled-egg','bread','broccoli','burger-cheese','burger','cake','candy-bar','carrot','cheese-cut','cheese','cherries','chicken-drumstick','chicken-leg','chocolate','chocolate-wrapper','coffee-beans','coffee','cookie-chocolate','cookie','croissant','cupcake','danish','donut-chocolate','donut','donut-sprinkles','egg-cooked','egg-fried','egg','fish','garlic','ginger-bread','grapes','honey','hotdog','ice-cream-cone','ice-cream','jar','juice-box','kebab','lollypop','macaroon','marshmallow','meat-cooked','meat-raw','meat-sausage','melon','milk','muffin','mushroom','onion-sliced','onion','orange','pancakes','pear','pepper','pineapple','pizza','popcorn','popsicle-chocolate','popsicle','popsicle-stick','pudding','pumpkin','radish','sashimi','strawberry','sushi-egg','sushi-salmon','sushi','tomato','watermelon','waffle','whippy'],
    star:'assets/sprites/extracted_kenney_space-shooter/PNG/Power-ups/powerupBlue_star.png',
    blaster:'assets/sprites/extracted_kenney_space-shooter/PNG/Power-ups/powerupBlue_bolt.png',
    playerLaser:'assets/sprites/extracted_kenney_space-shooter/PNG/Lasers/laserBlue01.png',
    enemyLaser:'assets/sprites/extracted_kenney_space-shooter/PNG/Lasers/laserRed01.png'
};

const playlist=["Baby (Is it a Crime) - Rema (Lyric video).mp3","Backstreet Boys - Everybody (Backstreet's Back) (Lyrics).mp3","Billie Eilish - BIRDS OF A FEATHER (Official Lyric Video).mp3","Dave & Central Cee - Sprinter (Clean).mp3","Davido - If (lyrics).mp3","How You Remind Me - Nickelback (Clean Version).mp3","TLC - Waterfalls (Lyrics).mp3","Sabrina Carpenter - Espresso.mp3"];

const cvs=document.getElementById('gameCanvas'),ctx=cvs.getContext('2d'),ui=document.getElementById('ui'),title=document.getElementById('titleScreen'),levelMsg=document.getElementById('levelMessage'),startBtn=document.getElementById('startBtn'),mute=document.getElementById('muteBtn'),bgm=document.getElementById('bgm'),starMusic=document.getElementById('starMusic'),loading=document.getElementById('loading');
const mobile=matchMedia('(pointer:coarse)').matches;

function fit(){const w=innerWidth-24,h=(innerHeight-(mobile?220:60))-24;cvs.width=w;cvs.height=h;}
addEventListener('resize',fit);fit();
const dirs={up:0,down:0,left:0,right:0};
const images={};
function loadImage(src){return new Promise((resolve)=>{const img=new Image();img.onload=()=>resolve(img);img.onerror=()=>resolve(null);img.src=src;});}

async function loadAllAssets(){
    const promises=[];
    promises.push(loadImage(ASSETS.player).then(img=>images.player=img));
    images.enemies=[];
    for(const src of ASSETS.enemies)promises.push(loadImage(src).then(img=>{if(img)images.enemies.push(img)}));
    images.cookies=[];
    for(const name of ASSETS.cookies)promises.push(loadImage(`assets/sprites/extracted_kenney_food-kit/Previews/${name}.png`).then(img=>{if(img)images.cookies.push(img)}));
    promises.push(loadImage(ASSETS.star).then(img=>images.star=img));
    promises.push(loadImage(ASSETS.blaster).then(img=>images.blaster=img));
    promises.push(loadImage(ASSETS.playerLaser).then(img=>images.playerLaser=img));
    promises.push(loadImage(ASSETS.enemyLaser).then(img=>images.enemyLaser=img));
    await Promise.all(promises);
    loading.style.display='none';
}

let p,cookies,mons,playerBullets,monsterBullets,particles,score,level,starTimer,blasterTimer,gameOver,run,monSpeed,star,blaster,autoFireCooldown,isPausedForMessage,starsSpawnedThisLevel,gunsSpawnedThisLevel,nextPowerupTrigger;
const R=()=>({x:40+Math.random()*(cvs.width-80),y:40+Math.random()*(cvs.height-80)});
const D=(a,b)=>Math.hypot(a.x-b.x,a.y-b.y);

let shuffledSongs=[];
function shufflePlaylist(){shuffledSongs=[...playlist];for(let i=shuffledSongs.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[shuffledSongs[i],shuffledSongs[j]]=[shuffledSongs[j],shuffledSongs[i]];}}
function nextSong(){if(!shuffledSongs.length)shufflePlaylist();const song=shuffledSongs.pop();if(song){bgm.src=encodeURI(song);bgm.play().catch(()=>{});}}
bgm.onended=nextSong;starMusic.loop=true;

eatSfx=()=>{if(!mute.classList.contains('muted')){const a=new Audio();a.src='assets/sounds/effects/sci_fi_sfx/coin_01.ogg';a.play().catch(()=>{});}};
levelSfx=()=>{};hitSfx=()=>{if(!mute.classList.contains('muted')){const a=new Audio();a.src='assets/sounds/effects/sci_fi_sfx/explosion_01.ogg';a.play().catch(()=>{});}};
fireSfx=()=>{if(!mute.classList.contains('muted')){const a=new Audio();a.src='assets/sounds/effects/sci_fi_sfx/shoot_01.ogg';a.play().catch(()=>{});}};
powerSfx=()=>{if(!mute.classList.contains('muted')){const a=new Audio();a.src='assets/sounds/effects/sci_fi_sfx/powerup_01.ogg';a.play().catch(()=>{});}};
blasterHitSfx=()=>{if(!mute.classList.contains('muted')){const a=new Audio();a.src='assets/sounds/effects/9_explosions/explosion_01.wav';a.play().catch(()=>{});}};

function reset(){
    p={x:cvs.width/2,y:cvs.height/2,dx:0,dy:0,angle:0};cookies=[];mons=[];playerBullets=[];monsterBullets=[];particles=[];
    score=0;level=1;monSpeed=BASE_MS;starTimer=0;blasterTimer=0;gameOver=0;star=null;blaster=null;autoFireCooldown=0;
    isPausedForMessage=false;starsSpawnedThisLevel=0;gunsSpawnedThisLevel=0;nextPowerupTrigger=15;
    spawnCookies();spawnMonsters(3+level);ui.textContent='Score: 0';nextSong();levelSfx();
}
function spawnCookies(){for(let i=0;i<20;i++){const c=R();c.imgIndex=Math.floor(Math.random()*images.cookies.length);cookies.push(c);}}
function spawnMonsters(n){
    const center={x:cvs.width/2,y:cvs.height/2};
    for(let i=0;i<n;i++){let m;do{m=R();}while(D(m,center)<MONSTER_SPAWN_BUFFER);
        let a=Math.random()*6.28;m.dx=Math.cos(a)*monSpeed;m.dy=Math.sin(a)*monSpeed;
        m.r=(level<MONSTER_SHOOT_LEVEL)?BASE_MR:BIG_MONSTER_R;m.cool=MON_SHOOT_COOLDOWN*(0.8+Math.random()*0.4);m.tCool=m.cool;
        m.imgIndex=Math.floor(Math.random()*images.enemies.length);mons.push(m);
    }
}
function proceedToNextLevel(){
    level++;starTimer=0;blasterTimer=0;starMusic.pause();if(!mute.classList.contains('muted'))bgm.play();
    star=null;blaster=null;starsSpawnedThisLevel=0;gunsSpawnedThisLevel=0;nextPowerupTrigger=15;
    spawnCookies();spawnMonsters(3+level);nextSong();levelSfx();
}
function fireCookie(){if(gameOver)return;fireSfx();playerBullets.push({x:p.x,y:p.y-15,dx:0,dy:-12});}
function fireMonster(m){if(level<MONSTER_SHOOT_LEVEL)return;const ang=Math.atan2(p.y-m.y,p.x-m.x);monsterBullets.push({x:m.x,y:m.y,dx:Math.cos(ang)*4,dy:Math.sin(ang)*4,angle:ang});}

function update(dt){
    if(gameOver||isPausedForMessage)return;
    const currentSpeed=starTimer>0?PS_BOOST:PS;
    p.dx=(dirs.left?-currentSpeed:0)+(dirs.right?currentSpeed:0);
    p.dy=(dirs.up?-currentSpeed:0)+(dirs.down?currentSpeed:0);
    p.x+=p.dx;p.y+=p.dy;
    p.x=Math.max(PR,Math.min(cvs.width-PR,p.x));p.y=Math.max(PR,Math.min(cvs.height-PR,p.y));
    if(p.dx>0)p.angle=0.1;else if(p.dx<0)p.angle=-0.1;else p.angle=0;
    if(starTimer>0){starTimer-=dt;if(starTimer<=0){starMusic.pause();if(!mute.classList.contains('muted'))bgm.play();}}
    if(blasterTimer>0){blasterTimer-=dt;if(autoFireCooldown>0)autoFireCooldown-=dt;else{fireCookie();autoFireCooldown=AUTO_FIRE_RATE;}}
    if(star){star.life-=dt;if(star.life<=0)star=null;}
    if(blaster){blaster.life-=dt;if(blaster.life<=0)blaster=null;}
    if(cookies.length<=nextPowerupTrigger&&nextPowerupTrigger>0){
        let potentialSpawns=[];if(starsSpawnedThisLevel<2&&!star)potentialSpawns.push('star');if(level>=MONSTER_SHOOT_LEVEL&&gunsSpawnedThisLevel<2&&!blaster)potentialSpawns.push('blaster');
        if(potentialSpawns.length>0){const type=potentialSpawns[Math.floor(Math.random()*potentialSpawns.length)];if(type==='star'){star={...R(),life:POWERUP_LIFETIME};starsSpawnedThisLevel++;}else if(type==='blaster'){blaster={...R(),life:POWERUP_LIFETIME};gunsSpawnedThisLevel++;}nextPowerupTrigger-=5;}
    }
    playerBullets.forEach(b=>b.y+=b.dy);monsterBullets.forEach(b=>{b.x+=b.dx;b.y+=b.dy;});
    playerBullets=playerBullets.filter(b=>b.y>-20);monsterBullets=monsterBullets.filter(b=>b.x>-20&&b.x<cvs.width+20&&b.y>-20&&b.y<cvs.height+20);
    mons.forEach(m=>{m.x+=m.dx;m.y+=m.dy;if(m.x<m.r||m.x>cvs.width-m.r)m.dx*=-1;if(m.y<m.r||m.y>cvs.height-m.r)m.dy*=-1;m.tCool-=dt;if(m.tCool<=0){fireMonster(m);m.tCool=m.cool;}});
    cookies=cookies.filter(c=>{if(D(c,p)<PR+BASE_CR){score+=10;ui.textContent='Score: '+score;eatSfx();return false;}return true;});
    if(star&&D(star,p)<PR+BOOST_R){star=null;starTimer=STAR_TIME;powerSfx();bgm.pause();starMusic.currentTime=0;starMusic.play();}
    if(blaster&&D(blaster,p)<PR+BOOST_R){blaster=null;blasterTimer=BLASTER_TIME;powerSfx();}
    playerBullets=playerBullets.filter(b=>{const hitMonster=mons.find(m=>D(b,m)<m.r+PLAYER_BULLET_R);if(hitMonster){mons=mons.filter(m=>m!==hitMonster);blasterHitSfx();score+=50;ui.textContent='Score: '+score;return false;}return true;});
    if(starTimer>0){mons=mons.filter(m=>{if(D(m,p)<m.r+PR){blasterHitSfx();score+=30;ui.textContent='Score: '+score;return false;}return true;});}
    else if(mons.some(m=>D(m,p)<m.r+PR)){gameOver=1;run=false;hitSfx();bgm.pause();starMusic.pause();}
    if(starTimer<=0&&monsterBullets.some(b=>D(b,p)<PR+MONSTER_BULLET_R)){gameOver=1;run=false;hitSfx();bgm.pause();starMusic.pause();}
    if(!cookies.length){if(level+1===MONSTER_SHOOT_LEVEL){isPausedForMessage=true;levelMsg.style.display='flex';}else{proceedToNextLevel();}}
}

function drawImageRotated(img,x,y,angle,scale=1){
    if(!img)return;ctx.save();ctx.translate(x,y);ctx.rotate(angle);const w=img.width*scale,h=img.height*scale;ctx.drawImage(img,-w/2,-h/2,w,h);ctx.restore();
}
function drawImageCentered(img,x,y,scale=1){
    if(!img)return;const w=img.width*scale,h=img.height*scale;ctx.drawImage(img,x-w/2,y-h/2,w,h);
}

function draw(){
    ctx.fillStyle='#000';ctx.fillRect(0,0,cvs.width,cvs.height);
    cookies.forEach(c=>{const img=images.cookies[c.imgIndex%images.cookies.length];if(img)drawImageCentered(img,c.x,c.y,0.6);});
    if(star&&images.star)drawImageCentered(images.star,star.x,star.y,1.0);
    if(blaster&&level>=MONSTER_SHOOT_LEVEL&&images.blaster)drawImageCentered(images.blaster,blaster.x,blaster.y,1.0);
    playerBullets.forEach(b=>{if(images.playerLaser)drawImageCentered(images.playerLaser,b.x,b.y,0.5);});
    monsterBullets.forEach(b=>{if(images.enemyLaser)drawImageRotated(images.enemyLaser,b.x,b.y,b.angle+Math.PI/2,0.5);});
    if(images.player){let scale=starTimer>0?1.1:1;if(blasterTimer>0)scale=1.05;drawImageRotated(images.player,p.x,p.y,p.angle,scale);if(starTimer>0){ctx.strokeStyle='#ffd700';ctx.lineWidth=3;ctx.beginPath();ctx.arc(p.x,p.y,PR+10+Math.sin(Date.now()/100)*3,0,Math.PI*2);ctx.stroke();}}
    mons.forEach(m=>{const img=images.enemies[m.imgIndex%images.enemies.length];if(img){const scale=m.r/25;drawImageCentered(img,m.x,m.y,scale);}});
    if(gameOver){ctx.fillStyle='rgba(0,0,0,.75)';ctx.fillRect(0,0,cvs.width,cvs.height);ctx.fillStyle='#fff';ctx.textAlign='center';ctx.font='8vw sans-serif';ctx.fillText('Game Over',cvs.width/2,cvs.height/2-20);ctx.font='4vw sans-serif';ctx.fillText('Click or Press R to restart',cvs.width/2,cvs.height/2+30);}
}

let last=0;
function loop(t){if(!run)return;const dt=t-last;last=t;update(dt);draw();requestAnimationFrame(loop);}
function startGame(){if(run)return;run=true;title.style.display='none';ui.style.display='block';fit();reset();last=performance.now();loop(last);}
function resumeAfterMessage(){if(!isPausedForMessage)return;isPausedForMessage=false;levelMsg.style.display='none';proceedToNextLevel();}

startBtn.addEventListener('click',startGame);
levelMsg.addEventListener('click',resumeAfterMessage);
function handlePress(dir){dirs[dir]=1;}function handleRelease(dir){dirs[dir]=0;}
addEventListener('keydown',e=>{if(isPausedForMessage){resumeAfterMessage();return;}if(!run&&e.key){startGame();return;}if(gameOver&&e.key==='r'){startGame();return;}if(e.key==='ArrowUp'||e.key==='w')handlePress('up');if(e.key==='ArrowDown'||e.key==='s')handlePress('down');if(e.key==='ArrowLeft'||e.key==='a')handlePress('left');if(e.key==='ArrowRight'||e.key==='d')handlePress('right');});
addEventListener('keyup',e=>{if(e.key==='ArrowUp'||e.key==='w')handleRelease('up');if(e.key==='ArrowDown'||e.key==='s')handleRelease('down');if(e.key==='ArrowLeft'||e.key==='a')handleRelease('left');if(e.key==='ArrowRight'||e.key==='d')handleRelease('right');});
if(mobile){
    document.getElementById('up').addEventListener('touchstart',e=>{e.preventDefault();handlePress('up');});
    document.getElementById('down').addEventListener('touchstart',e=>{e.preventDefault();handlePress('down');});
    document.getElementById('left').addEventListener('touchstart',e=>{e.preventDefault();handlePress('left');});
    document.getElementById('right').addEventListener('touchstart',e=>{e.preventDefault();handlePress('right');});
    document.getElementById('up').addEventListener('touchend',e=>{e.preventDefault();handleRelease('up');});
    document.getElementById('down').addEventListener('touchend',e=>{e.preventDefault();handleRelease('down');});
    document.getElementById('left').addEventListener('touchend',e=>{e.preventDefault();handleRelease('left');});
    document.getElementById('right').addEventListener('touchend',e=>{e.preventDefault();handleRelease('right');});
}
cvs.addEventListener('click',()=>{if(gameOver)startGame();});
mute.onclick=()=>{const isMuted=mute.classList.toggle('muted');bgm.muted=isMuted;starMusic.muted=isMuted;mute.textContent=isMuted?'ðŸ”‡':'ðŸ”Š';};

loadAllAssets().then(()=>{console.log('All assets loaded!');});
</script>
</body>
</html>
